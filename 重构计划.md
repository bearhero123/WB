# 微博自动签到系统 — 全栈重构计划

## TL;DR

从零构建微博自动签到系统的**服务端 + 管理后台 + Docker 部署**。技术栈：**FastAPI + PostgreSQL + Vue 3 + Element Plus**，使用 **docker-compose** 一键编排。系统保留现有 GUI 客户端的全部交互协议不变（API 路径、Header、Payload 格式完全兼容），服务端实现账号管理、会员 Key 鉴权、Cookie 存储、APScheduler 定时调度、超话签到（待用户提供 API 后补充）、Server酱推送。管理员通过 Web UI 管理一切，用户通过已有 GUI 客户端上传 Cookie。

## 技术选型

| 层级 | 选型 | 说明 |
|------|------|------|
| 服务端框架 | Python FastAPI | 与 GUI 同语言生态，异步高性能 |
| 数据库 | PostgreSQL 15 | 稳健可扩展 |
| ORM | SQLAlchemy 2.0 (async) | 异步支持，Alembic 迁移 |
| 定时调度 | APScheduler (AsyncIOScheduler) | 每个账号独立 CronJob |
| 管理后台 | Vue 3 + Vite + Element Plus | 现代化 SPA 管理界面 |
| 容器编排 | docker-compose | 一键部署 backend + db + frontend |
| 管理员鉴权 | 固定 API Key（.env 配置） | 简单可靠 |
| 推送渠道 | Server酱 | 文档要求 |

## 关键决策

| 决策点 | 结论 |
|--------|------|
| `sync_env` 字段 | 服务端接受但忽略，统一用数据库管理配置 |
| 双 Header 兼容 | 同时检查 `X-Member-Key` 和 `X-Access-Key`，任一匹配即可 |
| 端口 | backend 映射 `1234:8000`，与 GUI 默认 `DEFAULT_SERVER_URL` 兼容 |
| 签到 API | 已确认，支持双方案切换：方案 A（cardlist + page/button）、方案 B（container_timeline_topicsub + page/button） |
| 签到策略切换 | 运行时可配置 `checkin_provider`（`cardlist` / `topicsub`），默认 `cardlist` |
| 时区 | 全部容器统一 `Asia/Shanghai` |

---

## 项目结构

```
WeiBo/
├── docker-compose.yml              # 编排：backend + db + frontend
├── .env.example                     # 环境变量模板
├── 文档.md                          # 保留原文档
├── weibo_cookie_gui.py             # 保留原 GUI 客户端
│
├── backend/                         # FastAPI 服务端
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── alembic.ini
│   ├── alembic/                     # 数据库迁移
│   │   ├── env.py
│   │   └── versions/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                  # FastAPI 入口、生命周期管理
│   │   ├── config.py                # 环境变量配置 (pydantic-settings)
│   │   ├── database.py              # SQLAlchemy 引擎、Session 管理
│   │   ├── models/                  # ORM 模型
│   │   │   ├── __init__.py
│   │   │   ├── account.py           # 账号模型
│   │   │   ├── member_key.py        # 会员 Key 模型
│   │   │   └── task_log.py          # 任务/推送日志模型
│   │   ├── schemas/                 # Pydantic 校验模型
│   │   │   ├── __init__.py
│   │   │   ├── account.py
│   │   │   ├── member_key.py
│   │   │   └── external.py          # 外部 API 请求/响应模型
│   │   ├── api/                     # 路由
│   │   │   ├── __init__.py
│   │   │   ├── external.py          # /api/external/* (用户 API)
│   │   │   ├── admin_accounts.py    # /api/admin/accounts/*
│   │   │   ├── admin_keys.py        # /api/admin/keys/*
│   │   │   ├── admin_tasks.py       # /api/admin/tasks/*
│   │   │   └── admin_push.py        # /api/admin/push/*
│   │   ├── services/                # 业务逻辑层
│   │   │   ├── __init__.py
│   │   │   ├── account_service.py   # 账号 CRUD
│   │   │   ├── key_service.py       # Key 生命周期管理
│   │   │   ├── checkin_service.py   # 超话签到核心逻辑
│   │   │   ├── cookie_service.py    # Cookie 校验逻辑
│   │   │   ├── push_service.py      # Server酱推送
│   │   │   ├── scheduler_service.py # APScheduler 调度管理
│   │   │   └── weibo_client.py      # 微博 API 请求适配层（双方案策略）
│   │   ├── middleware/
│   │   │   ├── __init__.py
│   │   │   └── auth.py              # 鉴权依赖
│   │   └── utils/
│   │       ├── __init__.py
│   │       └── security.py          # SHA256 哈希、Key 生成
│   └── tests/
│       └── ...
│
└── frontend/                        # Vue 3 管理后台
    ├── Dockerfile
    ├── nginx.conf
    ├── package.json
    ├── vite.config.ts
    ├── tsconfig.json
    ├── src/
    │   ├── App.vue
    │   ├── main.ts
    │   ├── router/index.ts
    │   ├── api/                     # Axios API 封装
    │   │   ├── index.ts             # Axios 实例
    │   │   ├── accounts.ts
    │   │   ├── keys.ts
    │   │   ├── tasks.ts
    │   │   └── push.ts
    │   ├── views/                   # 页面
    │   │   ├── Dashboard.vue        # 总览
    │   │   ├── Accounts.vue         # 账号管理
    │   │   ├── Keys.vue             # 密钥管理
    │   │   ├── Logs.vue             # 日志查看
    │   │   └── Settings.vue         # 系统设置
    │   ├── layouts/
    │   │   └── AdminLayout.vue      # 后台布局（侧边栏+顶栏）
    │   └── components/
    │       └── ...
    └── public/
```

---

## 实施步骤

### 第一步：基础设施搭建

1. 创建 `docker-compose.yml`，编排三个服务：
   - **db**: PostgreSQL 15，挂载 `./data/postgres` 持久化，时区 `Asia/Shanghai`
   - **backend**: FastAPI 应用，依赖 `db`，端口映射 `1234:8000`（与 GUI 客户端默认端口兼容）
   - **frontend**: Nginx 容器，端口映射 `1235:80`，反代 `/api` 到 backend

2. 创建 `.env.example`，包含：
   - `DATABASE_URL=postgresql+asyncpg://weibo:weibo@db:5432/weibo`
   - `ADMIN_API_KEY=<管理员密钥>`
   - `DEFAULT_SENDKEY=<Server酱默认SendKey>`
   - `CHECKIN_PROVIDER=cardlist`（签到策略：`cardlist` 或 `topicsub`）
   - `WEIBO_API_PARAMS=<JSON格式的抓包参数，如aid/c/s/gsid等>`
   - `TZ=Asia/Shanghai`

3. 创建 `backend/Dockerfile`（Python 3.13-slim 基础镜像，pip install，uvicorn 启动）

4. 创建 `frontend/Dockerfile`（node:20 构建阶段 + nginx:alpine 运行阶段）

### 第二步：后端数据层

5. 在 `app/config.py` 中使用 `pydantic-settings` 读取环境变量：`DATABASE_URL`、`ADMIN_API_KEY`、`DEFAULT_SENDKEY`、`TZ`

6. 在 `app/database.py` 中配置 SQLAlchemy async engine + `AsyncSession`

7. 在 `app/models/account.py` 中定义 `Account` ORM 模型：
   - `id` (Integer, PK)
   - `account_name` (String, unique, not null) — 唯一账号名
   - `cookie_sub` (String, nullable) — SUB
   - `cookie_subp` (String, nullable) — SUBP
   - `cookie_twm` (String, nullable) — _T_WM
   - `cookie_updated_at` (DateTime, nullable) — Cookie 最后更新时间
   - `schedule_enabled` (Boolean, default=False)
   - `schedule_time` (String, default="08:00") — HH:MM
   - `schedule_random_delay` (Integer, default=300)
   - `retry_count` (Integer, default=3) — 签到重试次数
   - `request_interval` (Float, default=2.0) — 请求间隔秒数
   - `sendkey` (String, nullable) — 账号级 Server酱 SendKey
   - `last_checkin_at` (DateTime, nullable) — 最后签到时间
   - `last_checkin_status` (String, nullable) — 最后签到状态
   - `created_at` / `updated_at` (DateTime)

8. 在 `app/models/member_key.py` 中定义 `MemberKey` ORM 模型：
   - `id` (Integer, PK)
   - `label` (String, not null) — 展示标签
   - `key_hash` (String(64), unique, not null) — SHA-256 哈希值
   - `bound_account_id` (Integer, FK → Account.id, nullable)
   - `enabled` (Boolean, default=True)
   - `expires_at` (DateTime, nullable)
   - `last_used_at` (DateTime, nullable)
   - `created_at` (DateTime)

9. 在 `app/models/task_log.py` 中定义 `TaskLog` ORM 模型：
   - `id`、`account_id`、`event_type`（checkin / cookie_update / cookie_invalid / push_test）
   - `status`（success / partial / fail）
   - `detail`（JSON，存签到统计等）
   - `created_at`

10. 配置 Alembic 自动迁移，`alembic.ini` 中引用 `DATABASE_URL`

### 第三步：鉴权中间件

11. 在 `app/middleware/auth.py` 中实现两套鉴权（FastAPI `Depends` 依赖注入）：
    - **管理员鉴权**：检查 `X-Admin-Key` Header，与环境变量 `ADMIN_API_KEY` 比对
    - **会员 Key 鉴权**：检查 `X-Member-Key` 或 `X-Access-Key` Header → SHA-256 → 与数据库 `key_hash` 匹配 → 校验 `enabled` 和 `expires_at` → 更新 `last_used_at`

### 第四步：外部 API（兼容现有 GUI）

12. **`POST /api/external/key/verify`**：
    - 依赖：会员 Key 鉴权
    - 鉴权通过即返回 `{ "ok": true, "account_name": "<绑定的账号名或null>" }`
    - 失败返回 `{ "ok": false, "message": "..." }`

13. **`POST /api/external/cookie/update`**：
    - 依赖：会员 Key 鉴权
    - 请求体字段（与 GUI Payload 完全一致）：`account_name`、`SUB`、`SUBP`、`_T_WM`、`sync_env`（接受但忽略）、`schedule`（含 `enabled`/`time`/`random_delay`）、`apply_schedule`
    - 绑定规则：
      - Key 未绑定 → `account_name` 必填，首次成功后自动绑定
      - Key 已绑定 → 只能更新绑定账号，`account_name` 不匹配则拒绝
    - 更新账号的 Cookie + 定时配置
    - 若 `apply_schedule=true` → 调用调度器服务重新应用该账号定时任务
    - 触发"Cookie 更新成功"推送
    - 响应：`{ "ok": true, "message": "...", "account": "...", "notification": {...}, "cron": {...} }`

### 第五步：管理员 API

14. **账号管理** `app/api/admin_accounts.py`：
    - `GET /api/admin/accounts` — 列表（支持分页）
    - `GET /api/admin/accounts/{id}` — 详情
    - `POST /api/admin/accounts` — 创建账号
    - `PUT /api/admin/accounts/{id}` — 更新账号全部字段
    - `DELETE /api/admin/accounts/{id}` — 删除账号

15. **Key 管理** `app/api/admin_keys.py`：
    - `GET /api/admin/keys` — 列表
    - `POST /api/admin/keys` — 创建 Key（生成随机 UUID 明文 → SHA-256 存库 → **仅此一次返回明文**）
    - `PUT /api/admin/keys/{id}` — 更新（标签、启用状态、过期时间、绑定账号）
    - `DELETE /api/admin/keys/{id}` — 删除

16. **任务管理** `app/api/admin_tasks.py`：
    - `POST /api/admin/tasks/{account_id}/checkin` — 手动触发签到
    - `POST /api/admin/tasks/{account_id}/validate-cookie` — 手动校验 Cookie
    - `POST /api/admin/tasks/apply-schedules` — 重新应用所有定时任务
    - `GET /api/admin/tasks/logs` — 查询日志（分页、按账号/时间/事件类型过滤）

17. **推送管理** `app/api/admin_push.py`：
    - `POST /api/admin/push/test` — 测试推送（指定目标 SendKey 或账号）
    - `GET /api/admin/push/logs` — 推送日志

### 第六步：核心业务服务

18. **Cookie 有效性校验** `cookie_service.py`：
    - 使用 Cookie 访问 `https://m.weibo.cn/api/config`
    - 判断返回的 `login` 字段是否为 `true`
    - 返回校验结果 + 用户信息

19. **微博 API 请求适配层** `weibo_client.py`：

    统一封装微博 API 请求，提供策略切换能力。

    **通用职责：**
    - 统一 headers（User-Agent 移动端）、超时（10s）、重试（3 次指数退避）
    - 统一错误映射：所有上游返回统一为 `CheckinResult(status, detail)`
      - `status`: `success`（新签到）/ `already`（已签到）/ `failed`（失败）
    - 统一 Cookie 注入：从账号的 `SUB`、`SUBP`、`_T_WM` 构建请求 Cookie
    - 请求参数（`aid`、`c`、`s`、`gsid`、`from` 等抓包参数）存为结构化配置，便于版本变动时只改配置

    **方案 A：`CardlistProvider`（默认）**

    步骤 1 — 获取超话卡片列表：
    - `GET https://api.weibo.cn/2/cardlist`
    - Query 参数：抓包得到的完整 cardlist query（含 `aid`、`c`、`s`、`gsid`、`from`、`containerid` 等）
    - 响应解析：遍历 `cards → card_group`，筛选 `card_type == 8`，提取 `scheme`（含 containerid）和 `title_sub`（超话名）
    - 分页：通过 `since_id` 参数翻页，直到没有更多数据

    步骤 2 — 构造签到 request_url：
    - 从 `scheme` URL 中提取 `containerid` 参数
    - 拼接：`http://i.huati.weibo.com/mobile/super/active_fcheckin?cardid=bottom_one_checkin&container_id={containerid}&pageid={containerid}&scheme_type=1`

    步骤 3 — 执行签到：
    - `GET https://api.weibo.cn/2/page/button`
    - 关键参数：`aid`、`b`、`c`、`from`、`ft`、`gsid`、`lang`、`networktype`、`s`、`wm`、`fid=232478_-_one_checkin`、`request_url=<步骤2构造值>`、`since_id`
    - 结果判定：以响应中的 `msg` 字段（如 "已签到"）或结果码判断 success / already / failed

    **方案 B：`TopicsubProvider`**

    步骤 1 — 拉取可签到超话列表：
    - `POST https://api.weibo.cn/2/statuses/container_timeline_topicsub`
    - Query 参数：来自抓包 URL（`params`）
    - JSON Body：`{ "flowId": "232478_-_one_checkin", "since_id": "..." }`
    - 响应解析：遍历 `items → items → data → buttons`，提取 `action`（含 request_url）、`container_id`（即 ext_uid）、`title_sub`
    - 分页：通过 `since_id` 翻页

    步骤 2 — 执行签到：
    - `POST https://api.weibo.cn/2/page/button`
    - 关键参数：`aid`、`b`、`c`、`from`、`gsid`、`s`、`fid=232478_-_one_checkin`、`request_url=<从action提取>`、`ext_uid=<container_id>`
    - 结果判定：`result == 1` 视为 success

    **策略切换：**
    - 配置项 `CHECKIN_PROVIDER`（环境变量，默认 `cardlist`）
    - 运行时通过工厂函数 `get_provider(name)` 获取对应 Provider 实例
    - 两个 Provider 实现相同接口 `async def get_topics() -> List[Topic]` + `async def checkin(topic) -> CheckinResult`

20. **超话签到** `checkin_service.py`：
    - 业务编排层，不直接调用微博 API，通过 `weibo_client` 适配层操作
    - 完整流程：
      1. 调用 `cookie_service` 校验 Cookie 有效性
      2. 无效 → 记录日志（event_type=`cookie_invalid`） + 推送告警 → 结束
      3. 有效 → 通过 `weibo_client` 获取关注的超话列表
      4. 遍历超话列表，逐个调用 `weibo_client.checkin(topic)`
      5. 每次签到后等待 `request_interval` 秒（默认 2.0s）
      6. 失败项重试 `retry_count` 次（默认 3 次）
      7. 汇总统计：总数 / 新签到(`success`) / 已签到(`already`) / 失败(`failed`)
      8. 生成 Markdown 摘要，写入 TaskLog
      9. 推送签到结果
      10. 更新账号 `last_checkin_at` 和 `last_checkin_status`

21. **Server酱推送** `push_service.py`：
    - 发送方法：`POST https://sctapi.ftqq.com/{SendKey}.send`
    - `Content-Type: application/x-www-form-urlencoded`
    - 参数 `title` + `desp`
    - SendKey 优先级：账号级 → 系统默认 → 无则仅记日志
    - 失败重试：最多 3 次，间隔 2s / 4s / 8s 指数递增
    - 去重：同账号同事件类型 10 分钟内不重复推送
    - 消息模板按文档 §6.3 格式生成 Markdown
    - 5 个触发点：Cookie 上传成功/失败、签到完成、Cookie 失效、管理员测试

21. **定时调度** `scheduler_service.py`：
    - 使用 `APScheduler` (AsyncIOScheduler)
    - 应用启动时从数据库加载所有 `schedule_enabled=True` 的账号，创建 CronJob
    - 每个账号一个独立 Job，Job ID 为 `checkin_{account_id}`
    - 执行时间 = `schedule_time` + `random.randint(0, schedule_random_delay)` 秒随机偏移
    - 提供方法：
      - `apply_account_schedule(account_id)` — 单个重建
      - `apply_all_schedules()` — 全量重建
    - 调度变更写入日志

### 第七步：Vue 3 管理后台

22. 初始化 Vue 3 + Vite + TypeScript + Element Plus 项目

23. 实现路由和页面：
    - **Dashboard**：总览（账号数、今日签到状态、最近日志）
    - **Accounts**：账号列表 + 新增/编辑弹窗 + Cookie 状态 + 手动签到按钮 + 手动校验按钮
    - **Keys**：密钥列表 + 创建（弹窗显示明文 Key，仅一次）+ 启用/禁用/删除
    - **Logs**：签到日志 + 推送日志，支持按账号/事件/时间过滤
    - **Settings**：系统级配置（默认 SendKey 等）+ 推送测试按钮

24. 在 `frontend/nginx.conf` 中配置：
    - `location /api` → `proxy_pass http://backend:8000`
    - `location /` → 静态资源

### 第八步：Docker 集成与部署

25. `docker-compose.yml` 最终结构：
    ```yaml
    services:
      db:
        image: postgres:15
        volumes: ./data/postgres:/var/lib/postgresql/data
        environment: TZ=Asia/Shanghai
      backend:
        build: ./backend
        depends_on: db
        ports: "1234:8000"
        env_file: .env
      frontend:
        build: ./frontend
        depends_on: backend
        ports: "1235:80"
    ```

26. `backend/Dockerfile` 中包含 Alembic 自动迁移：
    - 启动命令：`alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000`

27. 创建 `scripts/deploy.sh` 一键部署脚本：拉取代码 → `docker-compose build` → `docker-compose up -d` → 健康检查

---

## API 完整规范

### 外部 API（用户可访问）

#### POST /api/external/key/verify

```
请求：
  Headers:
    Content-Type: application/json; charset=utf-8
    X-Member-Key: <明文Key>
    X-Access-Key: <明文Key>
  Body: {}

成功响应 (HTTP 200):
  { "ok": true, "account_name": "user_001" }

失败响应 (HTTP 401/403):
  { "ok": false, "message": "Key 无效或已过期" }
```

#### POST /api/external/cookie/update

```
请求：
  Headers:
    Content-Type: application/json; charset=utf-8
    X-Member-Key: <明文Key>
    X-Access-Key: <明文Key>
  Body:
    {
      "account_name": "user_001",
      "SUB": "...",
      "SUBP": "...",
      "_T_WM": "...",
      "sync_env": true,
      "schedule": {
        "enabled": true,
        "time": "08:00",
        "random_delay": 300
      },
      "apply_schedule": true
    }

成功响应 (HTTP 200):
  {
    "ok": true,
    "message": "Cookie 已更新成功",
    "account": "user_001",
    "notification": { "message": "通知发送结果" },
    "cron": { "message": "定时任务已应用" }
  }

失败响应 (HTTP 400/401/403):
  { "ok": false, "message": "错误描述" }
```

### 管理员 API

所有管理员 API 需要 `X-Admin-Key` Header 鉴权。

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/accounts | 账号列表 |
| GET | /api/admin/accounts/{id} | 账号详情 |
| POST | /api/admin/accounts | 创建账号 |
| PUT | /api/admin/accounts/{id} | 更新账号 |
| DELETE | /api/admin/accounts/{id} | 删除账号 |
| GET | /api/admin/keys | Key 列表 |
| POST | /api/admin/keys | 创建 Key（返回明文） |
| PUT | /api/admin/keys/{id} | 更新 Key |
| DELETE | /api/admin/keys/{id} | 删除 Key |
| POST | /api/admin/tasks/{account_id}/checkin | 手动签到 |
| POST | /api/admin/tasks/{account_id}/validate-cookie | 校验 Cookie |
| POST | /api/admin/tasks/apply-schedules | 应用全部定时 |
| GET | /api/admin/tasks/logs | 任务日志 |
| POST | /api/admin/push/test | 测试推送 |
| GET | /api/admin/push/logs | 推送日志 |

---

## 验收清单

- [ ] 外部接口无 Key 时返回 401，不泄露内部信息
- [ ] 有效 Key 仅能操作绑定账号
- [ ] Cookie 失效时可被检测并触发提醒
- [ ] 签到结果推送格式可被 Markdown 正常展示
- [ ] 账号调度修改后能立即生效
- [ ] 日志可完整追踪一次任务的输入、执行、推送结果
- [ ] GUI 客户端「验证 Key」「测试连通」「上传 Cookie」三个操作均正常
- [ ] 管理后台账号管理、Key 管理、日志查看、推送测试功能正常
- [ ] `docker-compose down && docker-compose up -d --build` 后数据持久化正常
- [ ] 全部容器时区为 Asia/Shanghai
- [ ] 签到方案 A（cardlist）可正常获取超话列表并逐个签到
- [ ] 签到方案 B（topicsub）可正常获取超话列表并逐个签到
- [ ] 切换 `CHECKIN_PROVIDER` 环境变量后，签到策略正确切换
- [ ] 签到结果统计（总数/新签到/已签到/失败）准确无误
- [ ] 微博 API 参数变动时，仅修改配置或适配层，不影响业务层
