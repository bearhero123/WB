# 微博自动签到系统重构逻辑文档（与具体代码解耦）

## 1. 文档目标

本文件用于保留业务逻辑，不依赖当前仓库文件结构，便于后续从零重构。

重构后无论技术栈如何变化，都应保证以下核心能力不变：

1. 管理员统一管理账号与密钥。
2. 用户只通过受限外部 API 上传 Cookie。
3. 按账号独立定时签到。
4. 签到结果和异常状态可推送、可追踪、可审计。

## 2. 系统边界与角色

### 2.1 管理员域（内网）

管理员通过后台进行系统配置，具备完整权限。

管理员可执行动作：

1. 管理微博账号。
2. 管理会员 Key（创建、禁用、过期、删除）。
3. 触发验证、手动签到、应用定时任务。
4. 查看日志、查看推送结果。

### 2.2 用户域（外网）

用户不进入管理后台，只使用外部工具调用受限 API。

用户可执行动作：

1. 验证会员 Key 是否有效。
2. 上传 Cookie 与该账号的定时参数。

用户不可执行动作：

1. 查看其他账号信息。
2. 修改全局配置。
3. 修改与 Cookie/定时无关的字段。

## 3. 关键对象模型

### 3.1 账号对象

账号对象需包含：

1. 账号标识（唯一名称）。
2. Cookie 信息（`SUB`、`SUBP`、`_T_WM`）。
3. 定时信息（是否启用、执行时间、随机延迟）。
4. 运行参数（重试次数、请求间隔等）。
5. 通知参数（如个人推送密钥）。

### 3.2 会员 Key 对象

会员 Key 对象需包含：

1. Key 唯一 ID。
2. 展示标签。
3. `key_hash`（SHA256）。
4. 绑定账号（可为空）。
5. 启用状态。
6. 过期时间。
7. 最近使用时间。

安全原则：

1. 服务端只保存哈希值，不保存明文 Key。
2. 请求鉴权时对输入 Key 做 SHA256 比对。

## 4. 端到端业务流程

### 4.1 发放密钥流程

1. 管理员创建会员 Key，可配置是否预绑定账号、是否限时。
2. 系统仅在创建时返回一次明文 Key。
3. 管理员将明文 Key 下发给用户。

### 4.2 用户上传 Cookie 流程

1. 用户在外部工具中填写服务器地址和会员 Key。
2. 先调用外部验证接口，确认 Key 有效。
3. 用户登录微博并提取 Cookie。
4. 用户提交 Cookie 与定时参数。
5. 服务端按绑定规则更新账号配置。
6. 服务端返回更新结果，并触发“Cookie 更新通知”。

### 4.3 账号绑定规则

1. 若 Key 未绑定账号，首次上传必须指定账号名。
2. 首次成功上传后，Key 自动绑定该账号。
3. 绑定后该 Key 只能更新对应账号，不能跨账号写入。

### 4.4 自动签到流程

1. 调度器到点触发签到任务。
2. 任务读取账号 Cookie 与定时配置。
3. 先执行 Cookie 有效性校验。
4. 有效时执行超话签到并统计结果。
5. 无效时输出失效日志并触发异常通知。
6. 任务结束后生成摘要并推送。

## 5. API 设计边界

### 5.1 外部 API（用户可访问）

必须至少保留：

1. `POST /api/external/key/verify`
2. `POST /api/external/cookie/update`

`cookie/update` 的允许字段应限定为：

1. Cookie 字段。
2. 定时字段（启用、时间、随机延迟）。
3. 必要控制字段（是否应用定时、是否同步环境变量）。

外部传入的其他字段应忽略或拒绝。

### 5.2 内部 API（仅管理员）

管理员 API 用于：

1. 账号管理。
2. Key 生命周期管理。
3. 手动触发任务与日志读取。

## 6. 推送系统详细规范

本节为重构重点，需保证行为清晰、可测试。

### 6.1 推送渠道与发送方式

默认渠道：Server酱。

发送方式：

1. 请求地址：`https://sctapi.ftqq.com/{SendKey}.send`
2. 请求方法：`POST`
3. Content-Type：`application/x-www-form-urlencoded`
4. 请求参数：`title`、`desp`

说明：

1. `title` 是推送标题。
2. `desp` 是 Markdown 正文。
3. Server酱成功通常返回 HTTP 200 且业务码为 0。

### 6.2 推送触发点

系统至少支持以下触发点：

1. Cookie 上传成功。
2. Cookie 上传失败。
3. 签到任务完成（成功、部分成功、失败）。
4. Cookie 校验失败（失效、过期、缺失）。
5. 管理员手动“测试推送”。

### 6.3 推送消息结构（Markdown）

推送内容统一采用 Markdown，建议格式：

1. 标题：事件名称。
2. 固定字段：账号、时间、任务类型、结果状态。
3. 统计字段：总数、成功数、失败数、已签到数。
4. 详情字段：失败项或关键提示。

示例：

```markdown
### 签到任务结果

- 账号: `user_001`
- 时间: `2026-02-11 08:00:12 +08:00`
- Cookie状态: `VALID`
- 总超话: `18`
- 新签到: `5`
- 已签到: `13`
- 失败: `0`

结论: 本次任务执行成功。
```

### 6.4 推送失败处理与重试

建议策略：

1. HTTP 非 200 判为失败。
2. HTTP 200 但业务码异常判为失败。
3. 推送失败自动重试 2 到 3 次。
4. 重试间隔递增，避免瞬时风暴。
5. 连续失败写入错误日志并在后台可见。

### 6.5 推送去重与频控

建议策略：

1. 同账号同事件短时间内去重。
2. 对“Cookie 无效”告警按时间窗口限频。
3. 重复失败优先聚合摘要，避免刷屏。

### 6.6 推送配置优先级

建议优先级：

1. 账号级 SendKey。
2. 系统级默认 SendKey。
3. 均不存在时只记录日志，不中断主流程。

### 6.7 推送测试能力

应提供“测试推送”接口或按钮，返回：

1. 请求是否发出。
2. 渠道返回码。
3. 错误详情（若失败）。

## 7. 调度与执行模型

### 7.1 定时配置

每个账号独立配置：

1. 是否启用。
2. 执行时间（HH:MM）。
3. 随机延迟秒数。

### 7.2 调度生效机制

1. 账号新增或修改后，需要重新应用调度。
2. 调度应用后，应有明确返回信息与日志。
3. 每个账号应生成可追踪的独立执行记录。

## 8. 可观测性与日志

建议至少保留三类日志：

1. API 访问日志（鉴权、请求结果、错误原因）。
2. 任务执行日志（Cookie 校验、签到明细、汇总）。
3. 推送日志（触发源、目标、返回码、错误详情）。

日志应包含：

1. 时间戳。
2. 账号标识。
3. 事件类型。
4. 结果状态。
5. 可定位错误信息。

## 9. 部署与运维原则

1. 管理后台仅内网开放。
2. 外部只开放必要 API。
3. 持久化配置与日志目录。
4. 固定容器时区，避免调度偏差。
5. 更新流程标准化：拉取代码、重建镜像、重启容器、验证路由、验证调度。

## 10. 重构实施建议（按阶段）

### 第一阶段：最小可用闭环

1. 账号模型与配置存储。
2. 单账号签到任务。
3. 基础日志与基础推送。

### 第二阶段：多账号与调度

1. 多账号并存与隔离。
2. 独立定时与统一调度应用。
3. 任务执行汇总与失败重试。

### 第三阶段：权限与外部接入

1. 会员 Key 哈希存储与生命周期管理。
2. 外部 API 限权模型。
3. 首次上传自动绑定逻辑。

### 第四阶段：可运维能力完善

1. 推送模板规范化。
2. 推送测试与限频策略。
3. 一键诊断脚本与版本一致性检查。

## 11. 重构验收清单

上线前建议逐项验证：

1. 外部接口无 Key 时返回未授权，不泄露内部信息。
2. 有效 Key 仅能操作绑定账号。
3. Cookie 失效时可被检测并触发提醒。
4. 签到结果推送格式可被 Markdown 正常展示。
5. 账号调度修改后能立即生效。
6. 日志可完整追踪一次任务的输入、执行、推送结果。

## 12. 参考接口整理（来自 sign_weibo_chaohua-master）

本节用于保存该参考项目里“微博超话签到”相关的实际请求链路，便于重构时做对照。

注意：

1. 这些接口属于逆向分析结果，不保证长期稳定。
2. 参数命名和必填项可能随微博版本变更。
3. 重构时建议做“接口适配层”，不要把参数硬编码到业务层。

### 12.1 方案 A：cardlist + page/button（weibo_chaohua_sign.py）

#### 步骤 1：获取超话卡片列表

1. 方法：`GET`
2. 端点：`https://api.weibo.cn/2/cardlist`
3. 参数来源：抓包得到的完整 cardlist URL query（常见含 `aid`、`c`、`s`、`gsid`、`from`、`containerid` 等）
4. 目标：从返回 `cards -> card_group` 提取 `card_type == 8` 的 `scheme` 和 `title_sub`

#### 步骤 2：构造签到 request_url

从 `scheme` 中提取 `containerid`，构造：

`http://i.huati.weibo.com/mobile/super/active_fcheckin?cardid=bottom_one_checkin&container_id={containerid}&pageid={containerid}&scheme_type=1`

#### 步骤 3：执行签到

1. 方法：`GET`（脚本复用统一 GET 请求函数）
2. 端点：`https://api.weibo.cn/2/page/button`
3. 关键参数（示例）：
4. `aid`、`b`、`c`、`from`、`ft`、`gsid`、`lang`、`networktype`、`s`、`wm` 等
5. `fid=232478_-_one_checkin`
6. `request_url=<上一步构造值>`
7. `since_id=<分页参数>`
8. 返回判定：常见以 `msg`（如“已签到”）或结果字段判断成功/失败

### 12.2 方案 B：container_timeline_topicsub + page/button（chaohua_sign.py）

#### 步骤 1：拉取可签到超话列表

1. 方法：`POST`
2. 端点：`https://api.weibo.cn/2/statuses/container_timeline_topicsub`
3. Query 参数：来自抓包 URL（`params`）
4. JSON Body：`flowId=232478_-_one_checkin` 等页面流参数 + `since_id`
5. 目标：从 `items -> items -> data -> buttons` 提取：
6. `action`（含 request_url 信息）
7. `container_id`（脚本命名 `ext_uid`）
8. `title_sub`（超话名）

#### 步骤 2：执行签到

1. 方法：`POST`
2. 端点：`https://api.weibo.cn/2/page/button`
3. 关键参数（示例）：
4. `aid`、`b`、`c`、`from`、`gsid`、`s`
5. `fid=232478_-_one_checkin`
6. `request_url=<从 action 中提取>`
7. `ext_uid=<container_id>`
8. 返回判定：常见以 `result == 1` 视为成功

### 12.3 参考项目中出现的其它微博端点（非超话签到主链）

1. 发微博接口：`https://api.weibo.cn/2/statuses/send`（`send_weibo` 脚本）
2. 该接口与超话签到逻辑可解耦，重构时建议独立模块实现。

### 12.4 重构落地建议（针对以上接口）

1. 做统一请求客户端：
   - 统一 headers、超时、重试、错误映射
2. 做接口版本适配：
   - `provider_cardlist`
   - `provider_topicsub`
   - 运行时可切换策略
3. 做参数抽象：
   - 把抓包得到的 query 参数存为结构化字段
   - 对 `request_url` 生成逻辑集中封装
4. 做结果标准化：
   - 无论上游返回什么，统一映射为 `success/already/failed + detail`
5. 做回归检查：
   - 每次微博版本变动，只改适配层，不改调度和业务层



docker compose up -d --build frontend