# WeiBo 项目结构（当前实际实现）

本文档基于当前仓库代码整理，描述真实可运行的结构、模块职责与关键调用链。

## 1. 根目录结构

```text
WeiBo/
├── backend/                         # FastAPI 后端
├── frontend/                        # Vue3 + Element Plus 管理后台
├── docker-compose.yml               # db/backend/frontend 编排
├── .env / .env.example              # 运行配置
├── README.md                        # 快速部署说明
├── 项目结构.md                      # 本文档
├── weibo_cookie_gui.py              # 本地 GUI 客户端（上传 Cookie）
├── weibo_cookie_gui_settings.json   # GUI 本地配置
└── 其他文档与历史目录
```

---

## 2. 后端结构（`backend/`）

```text
backend/
├── Dockerfile
├── requirements.txt
├── alembic.ini
├── alembic/
│   ├── env.py
│   └── versions/
│       ├── 001_init.py
│       └── 002_add_member_key_plain.py
└── app/
    ├── main.py
    ├── config.py
    ├── database.py
    ├── api/
    │   ├── external.py
    │   ├── admin_accounts.py
    │   ├── admin_keys.py
    │   ├── admin_tasks.py
    │   └── admin_push.py
    ├── middleware/
    │   └── auth.py
    ├── models/
    │   ├── account.py
    │   ├── member_key.py
    │   └── task_log.py
    ├── schemas/
    │   ├── account.py
    │   ├── member_key.py
    │   └── external.py
    ├── services/
    │   ├── account_service.py
    │   ├── key_service.py
    │   ├── cookie_service.py
    │   ├── checkin_service.py
    │   ├── weibo_client.py
    │   ├── scheduler_service.py
    │   └── push_service.py
    └── utils/
        ├── security.py
        └── time.py
```

### 2.1 核心模块职责

- `app/main.py`
  - FastAPI 入口。
  - 注册所有路由。
  - 启动时启动 APScheduler，并执行 `apply_all_schedules()` 重建定时任务。
  - 提供健康检查：`GET /api/health`。

- `app/config.py`
  - 读取 `.env`：`DATABASE_URL`、`ADMIN_API_KEY`、`DEFAULT_SENDKEY`、`CHECKIN_PROVIDER`、`WEIBO_API_PARAMS`、`TZ`。

- `app/middleware/auth.py`
  - 管理员鉴权：`X-Admin-Key`。
  - 会员鉴权：兼容 `X-Member-Key` / `X-Access-Key`，校验哈希、状态、过期时间，并更新 `last_used_at`。

- `app/models/`
  - `Account`：账号、Cookie、定时配置、重试参数、推送配置、最近签到状态。
  - `MemberKey`：密钥标签、`key_plain`（明文留存）、`key_hash`、绑定账号、启用与过期信息。
  - `TaskLog`：签到/推送/Cookie 相关日志。

- `app/services/checkin_service.py`
  - 单账号签到总编排：Cookie 校验 → 拉取超话 → 逐个签到（含重试）→ 统计汇总 → 写日志 → 推送。

- `app/services/weibo_client.py`
  - 微博接口适配层，支持 provider 策略（如 `cardlist`/`topicsub`/`mweibo` 回退）。

- `app/services/scheduler_service.py`
  - APScheduler 生命周期。
  - `apply_account_schedule(account_id)`：重建单账号任务。
  - `apply_all_schedules()`：重建所有启用任务。

- `app/services/push_service.py`
  - Server 酱推送封装与消息模板。

---

## 3. 前端结构（`frontend/`）

```text
frontend/
├── Dockerfile
├── nginx.conf
├── package.json
├── vite.config.ts
├── tsconfig.json
└── src/
    ├── main.ts
    ├── App.vue
    ├── env.d.ts
    ├── api/
    │   └── index.ts
    ├── router/
    │   └── index.ts
    ├── layouts/
    │   └── AdminLayout.vue
    ├── views/
    │   ├── Login.vue
    │   ├── Dashboard.vue
    │   ├── Accounts.vue
    │   ├── Keys.vue
    │   ├── Logs.vue
    │   └── Settings.vue
    └── utils/
        └── time.ts
```

### 3.1 页面与功能对应

- `Login.vue`：管理员密钥登录（写入 `localStorage.adminKey`）。
- `Dashboard.vue`：系统概览。
- `Accounts.vue`：账号管理、手动任务入口。
- `Keys.vue`：密钥管理（支持查看 `key_plain`，标签用于备注）。
- `Logs.vue`：任务日志查看。
- `Settings.vue`：健康检查、重载调度、推送测试、管理员本地密钥更新。

### 3.2 API 封装关键点

- 文件：`frontend/src/api/index.ts`
- Axios 基础配置：
  - `baseURL: '/api'`
  - `timeout: 60000`（已从 30000 调整到 60000）
- 请求拦截自动附带 `X-Admin-Key`。
- 健康检查走 `/health`（在前端代理下对应后端 `/api/health`）。

---

## 4. 对外接口分层

### 4.1 GUI 客户端调用（External）

前缀：`/api/external`

- `POST /key/verify`：验证会员密钥。
- `POST /cookie/update`：上传并更新 Cookie，可选应用定时配置。
- `POST /checkin/trigger`：按密钥绑定账号触发签到。
- `POST /push/test`：测试推送。

### 4.2 管理后台调用（Admin）

前缀：`/api/admin`

- `accounts`：账号 CRUD。
- `keys`：密钥 CRUD/生成。
- `tasks`：手动签到、批量签到、校验 Cookie、重载定时、日志查询。
- `push`：测试推送。

---

## 5. 运行与部署结构

- 编排文件：`docker-compose.yml`
- 服务：
  - `db`：PostgreSQL 15
  - `backend`：FastAPI（端口映射 `1234:8000`）
  - `frontend`：Nginx + Vue 静态资源（端口映射 `1235:80`）
- 时区统一通过 `TZ` 注入（默认 `Asia/Shanghai`）。

---

## 6. 当前关键实现状态（与近期改动一致）

1. 已修复后端 ORM 导入问题（`relationship` 从 `sqlalchemy.orm` 导入）。
2. 密钥模型已新增 `key_plain` 字段并有迁移 `002_add_member_key_plain.py`。
3. 前端 `Keys` 页面已展示密钥字段，不再将标签强行回填为密钥值。
4. 前端全局请求超时已调整为 `60000ms`，缓解签到耗时超过 30s 的超时报错。

---

## 7. 推荐维护顺序

1. 数据结构变更先写 Alembic 迁移（`backend/alembic/versions/`）。
2. 再改模型/Schema/Service。
3. 最后同步前端展示与交互。
4. 发布时优先确认：
   - `backend` 容器启动日志无异常；
   - `frontend` 容器已启动并代理正常；
   - `/api/health` 可访问。
